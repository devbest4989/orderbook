.form-horizontal.form-label-left{:style => "overflow:auto;"}
  .row.no-margin
    .col-md-6.col-sm-6.col-xs-12
      %h4 Order Main Information
      .form-group
        %label.control-label.col-md-4.col-sm-4.col-xs-12 Customer Name
        %span.col-md-8.col-sm-8.col-xs-12.field-value          
          = @sales_order.customer.name
      .form-group
        %label.control-label.col-md-4.col-sm-4.col-xs-12 Sales Order #
        %span.col-md-8.col-sm-8.col-xs-12.field-value          
          = @sales_order.token
    .col-md-6.col-sm-6.col-xs-12.text-right
      - if @sales_order.partial_shipped? || @sales_order.shipped?
        %a#btn_invoice_submit.btn.btn-primary{:href => 'javascript:;'}
          Save      
    .col-md-12{:style => "overflow:auto;"}
      %h4 Shipment Information
      / start project list
      %div
        %table#product_list.table.table-bordered.projects.margin-bottom-5
          %thead
            %tr
              %th 
                %input.group-checkable{type: 'checkbox'}
              %th Shipping Number
              %th Shipped Date
              %th Tracking Number
              %th Updated By
          - ship_token = @sales_order.invoice_activities_datas          
          - elem_num = @sales_order.ship_activities_elems
          - prev_data = ''
          - index = 0
          - @sales_order.ship_activities.each do |item|  
            - unless ship_token.include? item.token
              - if prev_data != item.token
                %tr
                  %td.bulk_action
                    %input{type: 'checkbox', value: "#{item.token}", name: "table_records"}
                  %td
                    =item.token              
                  %td
                    =item.created_at.to_date
                  %td
                    =item.track_number
                  %td
                    =item.updated_by.email
              - prev_data = item.token

  .ln_solid

  .row.no-margin  
    .col-md-6.col-sm-6.col-xs-12
      %h1= @sales_order.customer.company_title
    .col-md-6.col-sm-6.col-xs-12.text-right
      %h4.invoice_number=@sales_order_invoice.token unless @sales_order_invoice.nil?
  .row.no-margin  
    .col-md-6.col-sm-6.col-xs-12
      %h4= @sales_order.customer.billing_address
    .col-md-6.col-sm-6.col-xs-12
      %h4.invoice_date
        Date: 
        =@sales_order_invoice.created_at.to_date unless @sales_order_invoice.nil?
  .row.no-margin  
    .col-md-6.col-sm-6.col-xs-12
      %h5="Phone: #{@sales_order.customer.phone}"
      %h5="Fax: #{@sales_order.customer.fax}"
    .col-md-6.col-sm-6.col-xs-12
      %h5="Sales Order: #{@sales_order.token}"
      %h5="Processed By: #{@sales_order.booker.full_name}"
  .row.no-margin  
    .col-md-6.col-sm-6.col-xs-12
      %h4 
      %h5="#{@company_profiles['company.name']}"
      %h5="#{@company_profiles['company.address']}"
    .col-md-6.col-sm-6.col-xs-12
      %h4 Deliver To
      %h5="#{@sales_order.customer.company_title}"
      %h5="#{@sales_order.ship_street} #{@sales_order.ship_suburb}"
      %h5="#{@sales_order.ship_city} #{@sales_order.ship_postcode}"
      %h5="#{@sales_order.ship_state} #{Country.coded(@sales_order.ship_country).name}"
      %input#invoice_remove_url{type: 'hidden', value: "#{remove_activity_sales_order_path(@sales_order)}"}
      %input#invoice_get_url{type: 'hidden', value: "#{get_invoice_sales_order_path(@sales_order)}"}

  .row.no-margin  
    %table#product_list.table.projects.margin-bottom-5{:style => "table-layout: fixed;"}
      %thead
        %tr
          %th{ width: '30%' } Product Name
          %th Quantity
          %th Unit Price
          %th Discount (%)
          %th Tax (%)
          %th{ width: '20%' } Amount
      %tbody
      - unless @sales_order_invoice.nil?
        - @sales_order.sales_item_activities.where(activity: 'invoice').where(token: @sales_order_invoice.token).each do |item|
          %tr
            %td 
              =item.sales_item.sold_item.name
            %td 
              =item.quantity
            %td 
              ="$ #{item.sales_item.unit_price}"
            %td 
              =item.sales_item.discount_rate
            %td 
              =item.sales_item.tax_rate
            %td 
              =item.sub_total
    - unless @sales_order_invoice.nil?
      - @sales_order.sales_item_activities.where(activity: 'invoice').where(token: @sales_order_invoice.token).select("sum(sub_total) as sub_total, sum(discount) as discount, sum(tax) as tax, sum(total) as total").each do |item|
        %table.table.projects
          %tbody
            %tr
              %td{:style => 'border:none; background: white; text-align: right;'} 
                %b SubTotal:
              %td#sub_total_cell.money{:style => 'border:none; background: white; width:20%;'}
                =item.sub_total
            %tr
              %td{:style => 'border:none; background: white; text-align: right;'} 
                %b Total Discount:
              %td#discount_total_cell.money{:style => 'border:none; background: white; width:20%;'}
                =item.discount
            %tr
              %td{:style => 'border:none; background: white; text-align: right;'} 
                %b Shipping Cost:
              %td#ship_total_cell.money{:style => 'border:none; background: white; width:20%;'}
                / =@sales_order.shipping_cost
            %tr
              %td{:style => 'border:none; background: white; text-align: right;'} 
                %b Tax:
              %td#tax_total_cell.money{:style => 'border:none; background: white; width:20%;'}
                =item.tax
            %tr
              %td{:style => 'border:none; background: white; text-align: right;'} 
                %b Total:
              %td#total_cell.money{:style => 'border:none; background: white; width:20%;'}
                =item.total

  .ln_solid
  .row.no-margin
    .col-md-12{:style => "overflow:auto;"}
      %h4 Invoice List
      %div
        %table#invoice_activity_list.activity_list.table.table-bordered.projects.margin-bottom-5
          %thead
            %tr
              %th Invoice Number
              %th Invoice Date
              %th Updated By
              %th 
          - prev_data = ''
          - index = 0
          - @sales_order.invoice_activities.each do |item| 
            - index = index + 1
            - if prev_data != item.token
              ="<tr class='odd'><td><a href='javascript:;' class='invoice_link' data-token='#{item.token}'>#{item.token}</a></td><td>#{item.created_at.to_date}</td><td>#{item.updated_by.email}</td><td>#{'<a class="remove_track_link" href="javascript:;" data-activity="'+item.token+'"><i class="fa fa-icon fa-minus-circle"></i></a>'}</td></tr>".html_safe
              = "<tr class='even'><td colspan='6'><table class='table projects margin-bottom-5'><thead><tr><th>Shipping Number</th><th>SKU</th><th>Product Name</th><th>Shipped Qty</th><th>Note</th></tr></thead>".html_safe          
            %tr
              %td
                =item.activity_data              
              %td 
                =item.sales_item.sold_item.sku
              %td 
                =item.sales_item.sold_item.name
              %td 
                =item.quantity
              %td 
                =item.note
            - if index == @sales_order.ship_activities.length
              ="</table></td></tr>".html_safe
            - prev_data = item.token          
:javascript
  $(document).ready(function() {
    SalesOrderDetail.handleOrderInvoiceTab();
  });
